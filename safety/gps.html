<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>S-RAY Surveillance v8.0 - Cyber Core</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="logo.png" type="image/png" />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap");

      body {
        margin: 0;
        background-color: #050510;
        font-family: "Rajdhani", sans-serif;
        color: white;
        overflow-x: hidden;
        overflow-y: auto;
      }

      /* Desktop Lock */
      @media (min-width: 1024px) {
        body {
          overflow: hidden;
        }
      }

      /* --- UTILITY CLASSES --- */
      .font-orbitron {
        font-family: "Orbitron", sans-serif;
      }
      .hidden {
        display: none !important;
      }

      /* CRITICAL ALERT ATMOSPHERE */
      body.critical-mode {
        box-shadow: inset 0 0 50px rgba(255, 0, 0, 0.3);
      }
      body.critical-mode::after {
        content: "";
        position: fixed;
        inset: 0;
        background: linear-gradient(
          180deg,
          rgba(255, 0, 0, 0.1) 0%,
          transparent 10%,
          transparent 90%,
          rgba(255, 0, 0, 0.1) 100%
        );
        pointer-events: none;
        z-index: 9999;
        animation: pulse-screen 1s infinite alternate;
      }

      @keyframes pulse-screen {
        from {
          opacity: 0.3;
        }
        to {
          opacity: 0.7;
        }
      }

      #canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }

      /* Glassmorphism Panels */
      .glass-panel {
        background: rgba(10, 15, 25, 0.65);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(0, 240, 255, 0.15);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      /* Dynamic Border Glow */
      .glass-panel:hover {
        border-color: rgba(0, 240, 255, 0.5);
        box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
      }

      .tech-text {
        font-family: "Orbitron", sans-serif;
        letter-spacing: 2px;
      }

      /* INPUT STYLING */
      .cyber-input {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid #00f0ff;
        color: #00f0ff;
        font-family: "Orbitron", sans-serif;
        padding: 10px;
        outline: none;
        transition: all 0.3s ease;
      }
      .cyber-input:focus {
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
        background: rgba(0, 40, 60, 0.8);
      }

      /* Map Styling */
      #map {
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.5);
        z-index: 1;
        min-height: 300px;
      }

      /* Custom Leaflet Dark Mode tweaks */
      .leaflet-container {
        background: #000 !important;
      }
      .leaflet-control-attribution {
        display: none !important;
      }

      /* Scanner Lines - CLEANED UP */
      .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
        border: 1px solid rgba(0, 240, 255, 0.1); /* Faint border only */
        z-index: 20;
      }

      /* REMOVED .scan-line animation per user request */

      .corner {
        position: absolute;
        width: 20px;
        height: 20px;
        border-color: #00f0ff;
        border-style: solid;
        opacity: 0.5;
      }
      .tl {
        top: 0;
        left: 0;
        border-width: 2px 0 0 2px;
      }
      .tr {
        top: 0;
        right: 0;
        border-width: 2px 2px 0 0;
      }
      .bl {
        bottom: 0;
        left: 0;
        border-width: 0 0 2px 2px;
      }
      .br {
        bottom: 0;
        right: 0;
        border-width: 0 2px 2px 0;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }
      ::-webkit-scrollbar-thumb {
        background: #00f0ff;
        border-radius: 3px;
      }

      .stat-value {
        text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        transition: all 0.3s ease;
      }

      #chart-staging-area {
        position: absolute;
        top: -9999px;
        left: -9999px;
        width: 600px;
        height: 400px;
        background: white;
      }

      /* Loader for 3D scene initialization */
      #scene-loader {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 1s ease;
      }
    </style>
  </head>
  <!-- Responsive Body Classes -->
  <body class="min-h-screen w-full flex flex-col p-2 md:p-4 gap-4 box-border">
    <!-- 3D Background Container -->
    <div id="canvas-container"></div>

    <!-- Initial Scene Loader -->
    <div id="scene-loader">
      <div
        class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"
      ></div>
      <div class="text-cyan-500 font-orbitron tracking-widest animate-pulse">
        INITIALIZING NEURAL GRID...
      </div>
    </div>

    <div id="chart-staging-area">
      <canvas id="pdf-chart-pie" width="400" height="400"></canvas>
    </div>

    <!-- LANDING PAGE -->
    <div
      id="landing-page"
      class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4 overflow-hidden"
    >
      <div
        class="glass-panel p-6 md:p-10 rounded-xl text-center max-w-2xl w-full border-t-4 border-t-cyan-500 overflow-y-auto max-h-[90vh] relative z-10 transform translate-y-0"
        id="landing-panel"
      >
        <div
          class="absolute inset-0 bg-gradient-to-b from-cyan-900/10 to-transparent pointer-events-none"
        ></div>

        <i
          data-lucide="scan-eye"
          class="w-16 h-16 md:w-20 md:h-20 text-cyan-400 mx-auto mb-6"
          id="landing-logo"
        ></i>
        <h1
          class="text-3xl md:text-5xl font-orbitron text-white font-bold mb-2 tracking-wider"
        >
          S-RAY <span class="text-cyan-500">v8.0</span>
        </h1>
        <p
          class="text-cyan-400/80 tracking-[0.2em] mb-8 md:mb-10 text-xs md:text-sm font-bold"
        >
          SURVEILLANCE & GEO-SPATIAL INTELLIGENCE
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
          <button
            onclick="startSensorMode()"
            class="gsap-btn group relative p-4 md:p-6 border border-gray-600 rounded transition-all bg-black/40 text-left overflow-hidden"
          >
            <div
              class="absolute inset-0 bg-cyan-900/0 group-hover:bg-cyan-900/20 transition-colors duration-300"
            ></div>
            <div
              class="absolute top-2 right-2 text-cyan-500 opacity-0 group-hover:opacity-100 transition transform translate-x-2 group-hover:translate-x-0 duration-300"
            >
              <i data-lucide="arrow-right"></i>
            </div>
            <h3
              class="font-bold text-lg md:text-xl text-white mb-2 relative z-10 group-hover:text-cyan-400 transition-colors"
            >
              UPLINK NODE
            </h3>
            <p class="text-[10px] md:text-xs text-gray-400 relative z-10">
              Connect this device as a data collection sensor.
            </p>
          </button>

          <button
            onclick="showLogin()"
            class="gsap-btn group relative p-4 md:p-6 border border-gray-600 rounded transition-all bg-black/40 text-left overflow-hidden"
          >
            <div
              class="absolute inset-0 bg-red-900/0 group-hover:bg-red-900/20 transition-colors duration-300"
            ></div>
            <div
              class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition transform translate-x-2 group-hover:translate-x-0 duration-300"
            >
              <i data-lucide="lock"></i>
            </div>
            <h3
              class="font-bold text-lg md:text-xl text-white mb-2 relative z-10 group-hover:text-red-400 transition-colors"
            >
              COMMAND CENTER
            </h3>
            <p class="text-[10px] md:text-xs text-gray-400 relative z-10">
              Admin access. Requires Level 5 Security Clearance.
            </p>
          </button>
        </div>
      </div>
    </div>

    <!-- LOGIN MODAL -->
    <div
      id="login-view"
      class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
    >
      <div
        class="glass-panel p-6 md:p-8 rounded-lg w-full max-w-md relative transform scale-95 opacity-0"
        id="login-panel"
      >
        <button
          onclick="cancelLogin()"
          class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors"
        >
          <i data-lucide="x"></i>
        </button>

        <h2
          class="text-xl md:text-2xl font-orbitron text-cyan-400 mb-6 text-center"
        >
          IDENTITY VERIFICATION
        </h2>

        <div class="space-y-4">
          <div>
            <label class="block text-xs text-cyan-600 mb-1 tracking-widest"
              >AGENT ID</label
            >
            <input
              type="text"
              id="username"
              class="w-full cyber-input rounded"
              placeholder="Enter Agent ID"
            />
          </div>
          <div>
            <label class="block text-xs text-cyan-600 mb-1 tracking-widest"
              >ACCESS CODE</label
            >
            <input
              type="password"
              id="password"
              class="w-full cyber-input rounded"
              placeholder="••••••••••"
            />
          </div>

          <div
            id="login-error"
            class="hidden text-red-500 text-xs text-center font-mono border border-red-500/50 p-2 bg-red-900/20"
          >
            ACCESS DENIED: INVALID CREDENTIALS
          </div>

          <button
            onclick="checkLogin()"
            class="gsap-btn w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded border border-cyan-400 shadow-[0_0_15px_cyan] mt-4 transition-all"
          >
            AUTHENTICATE
          </button>
        </div>
      </div>
    </div>

    <!-- SENSOR VIEW (MOBILE FOCUSED) -->
    <div
      id="sensor-view"
      class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm transition-colors duration-500"
    >
      <!-- Back Button -->
      <button
        onclick="exitSensorMode()"
        class="absolute top-6 right-6 p-2 rounded-full border border-gray-600 hover:border-red-500 hover:bg-red-900/20 hover:text-red-500 text-gray-400 transition-all z-50"
        title="Exit to Main Menu"
      >
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>

      <div
        class="glass-panel p-8 rounded-full w-64 h-64 flex flex-col items-center justify-center border-4 border-cyan-500 relative transition-all duration-300"
        id="sensor-circle"
      >
        <div
          class="absolute inset-0 rounded-full border border-cyan-200 opacity-30 animate-ping"
          id="sensor-ping"
        ></div>
        <i
          data-lucide="radio"
          class="w-12 h-12 text-cyan-400 mb-2"
          id="sensor-icon"
        ></i>
        <h2 class="text-xl font-bold text-white" id="sensor-status-text">
          ACTIVE
        </h2>
        <p class="text-xs text-cyan-300 font-mono mt-2" id="sensor-sub-text">
          SENDING PACKETS
        </p>
      </div>

      <!-- User Alert Box -->
      <div id="user-alert-container" class="hidden mt-6 w-full max-w-sm px-4">
        <div
          class="bg-red-900/80 border border-red-500 rounded-lg p-4 flex flex-col items-center text-center animate-pulse shadow-[0_0_30px_rgba(255,0,0,0.5)]"
        >
          <i data-lucide="triangle-alert" class="text-white w-10 h-10 mb-2"></i>
          <h3 class="text-white font-bold text-lg mb-1 font-orbitron">
            SAFETY ALERT
          </h3>
          <p class="text-white text-sm font-bold leading-relaxed">
            Let's grab a seat to settle down safely to overcome the crowd
            running situation.
          </p>
        </div>
      </div>

      <div class="mt-8 text-center" id="sensor-stats">
        <p class="text-gray-500 text-xs font-mono mb-2">SESSION ID</p>
        <p
          id="displaySessionId"
          class="text-cyan-400 font-mono text-lg tracking-widest border border-cyan-800 px-4 py-1 rounded bg-black/50"
        >
          LOADING...
        </p>
        <p class="text-gray-600 text-[10px] mt-4">DO NOT CLOSE THIS WINDOW</p>
        <p class="text-gray-600 text-[10px]">
          LAST PING: <span id="lastPingTime">--:--:--</span>
        </p>
      </div>
    </div>

    <!-- SETUP MODAL -->
    <div
      id="setupModal"
      class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm items-center justify-center p-4"
    >
      <div
        class="glass-panel w-full max-w-lg p-6 rounded-lg relative overflow-y-auto max-h-[90vh]"
      >
        <button
          onclick="closeSetupModal()"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <i data-lucide="x"></i>
        </button>
        <h3 class="text-xl font-orbitron text-white mb-6 pb-2">
          CONFIGURE NEW SECTOR
        </h3>

        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="text-xs text-cyan-500">SECTOR NAME</label>
            <input
              type="text"
              id="zoneName"
              class="w-full cyber-input rounded"
              placeholder="e.g. North Gate A"
            />
          </div>
          <div class="col-span-2 md:col-span-1">
            <label class="text-xs text-cyan-500">LATITUDE</label>
            <input
              type="text"
              id="zoneLat"
              class="w-full cyber-input rounded"
              placeholder="0.0000"
            />
          </div>
          <div class="col-span-2 md:col-span-1">
            <label class="text-xs text-cyan-500">LONGITUDE</label>
            <input
              type="text"
              id="zoneLng"
              class="w-full cyber-input rounded"
              placeholder="0.0000"
            />
          </div>
          <div class="col-span-2 md:col-span-1">
            <label class="text-xs text-cyan-500">RADIUS (M)</label>
            <input
              type="number"
              id="zoneRadius"
              class="w-full cyber-input rounded"
              value="50"
            />
          </div>
          <div class="col-span-2 md:col-span-1">
            <label class="text-xs text-cyan-500">DENSITY LIMIT</label>
            <input
              type="number"
              id="zoneLimit"
              class="w-full cyber-input rounded"
              value="100"
            />
          </div>
        </div>

        <div class="mt-6 flex justify-end gap-2">
          <button
            onclick="closeSetupModal()"
            class="px-4 py-2 text-sm text-gray-400 hover:text-white"
          >
            CANCEL
          </button>
          <button
            onclick="submitSetup()"
            class="gsap-btn px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-sm"
          >
            INITIALIZE SECTOR
          </button>
        </div>
      </div>
    </div>

    <!-- PROFILE EDIT MODAL -->
    <div
      id="profileEditModal"
      class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm items-center justify-center p-4"
    >
      <div class="glass-panel w-full max-w-md p-6 rounded-lg relative">
        <button
          onclick="closeProfileEdit()"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <i data-lucide="x"></i>
        </button>
        <h3 class="text-xl font-orbitron text-white mb-6 pb-2">EDIT PROFILE</h3>

        <div class="space-y-4">
          <div>
            <label class="block text-xs text-cyan-500 mb-1"
              >COMMANDER NAME</label
            >
            <input
              type="text"
              id="edit-admin-name"
              class="w-full cyber-input rounded"
              placeholder="Enter Name"
            />
          </div>
          <div>
            <label class="block text-xs text-cyan-500 mb-1">AVATAR URL</label>
            <input
              type="text"
              id="edit-admin-avatar"
              class="w-full cyber-input rounded"
              placeholder="https://..."
            />
            <p class="text-[10px] text-gray-500 mt-1">
              Use DiceBear URL for avatars
            </p>
          </div>
          <button
            onclick="saveProfile()"
            class="gsap-btn w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 rounded mt-4"
          >
            SAVE CHANGES
          </button>
        </div>
      </div>
    </div>

    <!-- GLOBAL ALERT BOX (ADMIN) -->
    <div
      id="critical-alert-box"
      class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-red-950/95 border border-red-500 text-white px-8 py-6 rounded-xl shadow-[0_0_50px_rgba(255,0,0,0.8)] items-center gap-6 w-[95%] md:w-auto min-w-[300px] transform -translate-y-20 transition-transform duration-500 flex"
    >
      <div class="bg-red-500 p-3 rounded-full animate-pulse shrink-0">
        <i data-lucide="siren" class="w-8 h-8 md:w-10 md:h-10 text-white"></i>
      </div>
      <div>
        <h2
          class="font-orbitron font-bold text-xl md:text-2xl tracking-widest text-red-100 mb-1"
        >
          CRITICAL ALERT
        </h2>
        <p
          id="critical-alert-text"
          class="font-mono text-sm text-red-200 font-bold tracking-wide"
        >
          <!-- Text injected via JS -->
        </p>
      </div>
      <button
        onclick="dismissAlert()"
        class="ml-auto text-red-300 hover:text-white"
      >
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </div>

    <!-- MAIN DASHBOARD -->
    <!-- Responsive Grid: Stacks on mobile (grid-cols-1), 12 cols on desktop -->
    <div
      id="dashboard-view"
      class="hidden w-full flex-col relative z-10 lg:h-full lg:overflow-hidden opacity-0"
    >
      <div
        class="main-grid flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 h-auto lg:h-full relative pb-10 lg:pb-0"
      >
        <!-- LEFT PANEL -->
        <div
          class="col-span-1 lg:col-span-3 flex flex-col gap-4 order-2 lg:order-1"
        >
          <div
            class="glass-panel h-20 md:h-24 rounded-lg flex items-center justify-center relative overflow-hidden group shrink-0 dashboard-item"
          >
            <div
              class="absolute inset-0 bg-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
            ></div>
            <div class="flex items-center gap-2">
              <i
                data-lucide="globe"
                class="text-cyan-400 w-6 h-6 md:w-8 md:h-8"
              ></i>
              <span class="tech-text font-bold text-lg md:text-xl text-white"
                >S-RAY</span
              >
            </div>
          </div>

          <div
            class="glass-panel flex-1 rounded-lg p-4 md:p-6 flex flex-col items-center relative overflow-hidden min-h-[300px] dashboard-item"
          >
            <!-- Profile Section -->
            <div
              class="relative group cursor-pointer mb-4"
              onclick="openProfileEdit()"
              title="Edit Profile"
            >
              <div
                class="w-20 h-20 md:w-24 md:h-24 rounded-full border-2 border-cyan-400 p-1 relative overflow-hidden"
              >
                <img
                  id="admin-avatar"
                  src="https://api.dicebear.com/9.x/avataaars/svg?seed=Felix"
                  alt="User"
                  class="w-full h-full rounded-full bg-slate-800 object-cover"
                />
                <!-- Hover Edit Overlay -->
                <div
                  class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full"
                >
                  <i data-lucide="pencil" class="text-white w-6 h-6"></i>
                </div>
              </div>
              <div
                class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-black animate-pulse"
              ></div>
            </div>

            <div class="flex items-center gap-2">
              <h2
                id="admin-name"
                class="text-xl md:text-2xl font-bold tech-text text-white"
              >
                COMMANDER
              </h2>
              <button
                onclick="openProfileEdit()"
                class="text-gray-500 hover:text-cyan-400 transition"
              >
                <i data-lucide="pencil" class="w-3 h-3"></i>
              </button>
            </div>

            <p class="text-cyan-400/70 text-xs md:text-sm tracking-wider mb-6">
              CLEARANCE: LEVEL 5
            </p>

            <div class="w-full space-y-4 text-sm">
              <div class="flex justify-between items-center pb-2">
                <span class="text-gray-400">Sat-Link</span>
                <span id="connectionStatus" class="text-green-400 font-bold"
                  >CONNECTED</span
                >
              </div>
              <div class="flex justify-between items-center pb-2">
                <span class="text-gray-400">Drone Feed</span>
                <span class="text-white" id="model-status">Standby...</span>
              </div>
              <div class="flex justify-between items-center pb-2">
                <span class="text-gray-400">Network Grid</span>
                <span
                  class="text-white font-mono text-purple-400"
                  id="network-status"
                  >INACTIVE</span
                >
              </div>
            </div>

            <div class="mt-auto w-full pt-4 space-y-2">
              <button
                onclick="openSetupModal()"
                class="gsap-btn w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 text-gray-300 p-2 rounded flex items-center justify-center gap-2 transition-all text-xs"
              >
                <i data-lucide="plus-circle" class="w-3 h-3"></i>
                ADD SECTOR
              </button>
              <button
                onclick="generatePDFReport()"
                class="gsap-btn w-full bg-cyan-600/20 hover:bg-cyan-600/40 border border-cyan-500 text-cyan-300 p-3 rounded flex items-center justify-center gap-2 transition-all text-sm"
              >
                <i data-lucide="file-down" class="w-4 h-4"></i>
                MISSION REPORT
              </button>
              <button
                onclick="exitAdminMode()"
                class="gsap-btn w-full border border-red-500/50 text-red-500 p-2 rounded flex items-center justify-center gap-2 transition-all text-xs hover:bg-red-950/30"
              >
                LOGOUT
              </button>
            </div>
          </div>
        </div>

        <!-- CENTER MAP PANEL -->
        <div
          class="col-span-1 lg:col-span-6 flex flex-col order-1 lg:order-2 h-[500px] lg:h-auto"
        >
          <div
            class="glass-panel flex-1 rounded-lg p-1 relative flex flex-col h-full dashboard-item"
          >
            <div
              class="h-10 flex justify-between items-center px-4 bg-black/20 rounded-t mb-1 shrink-0"
            >
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-ping"></div>
                <span
                  id="sector-label"
                  class="text-red-500 font-bold tracking-widest text-[10px] md:text-xs"
                  >LIVE FEED // SECTOR 9</span
                >
              </div>
              <div class="text-xs text-cyan-400 font-mono" id="clock">
                00:00:00
              </div>
            </div>

            <div
              class="flex-1 bg-black relative rounded overflow-hidden group min-h-0 flex items-center justify-center"
              id="video-container"
            >
              <div id="map"></div>

              <div
                id="camera-placeholder"
                class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-30 p-4 text-center"
              >
                <i
                  data-lucide="satellite"
                  class="w-12 h-12 md:w-16 md:h-16 text-cyan-500 mb-4 animate-pulse"
                ></i>
                <h3 class="text-lg md:text-xl text-white font-bold mb-2">
                  SATELLITE UPLINK
                </h3>
                <p class="text-gray-500 mb-6 text-sm">
                  Establish Geo-Spatial Drone Link
                </p>

                <button
                  onclick="initSystem()"
                  id="init-btn"
                  class="gsap-btn px-6 py-2 md:px-8 md:py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold transition-all border border-cyan-400 shadow-[0_0_15px_rgba(0,240,255,0.5)] text-sm md:text-base"
                >
                  ESTABLISH LINK
                </button>
                <p
                  id="loading-text"
                  class="hidden text-cyan-400 mt-4 animate-pulse text-xs tracking-widest"
                >
                  CALIBRATING GPS...
                </p>
              </div>

              <div class="scanner-overlay z-20 pointer-events-none">
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>

                <div
                  class="absolute top-4 right-4 bg-black/60 px-2 py-1 rounded border border-cyan-500/30 text-[10px] text-cyan-400 font-mono"
                >
                  LAT: <span id="lat-display">0.00</span> | LNG:
                  <span id="lng-display">0.00</span>
                </div>

                <div
                  class="absolute bottom-4 right-4 w-10 h-10 md:w-12 md:h-12 border border-cyan-500/30 rounded-full flex items-center justify-center bg-black/40"
                >
                  <span class="text-xs text-cyan-400 font-bold">N</span>
                </div>
              </div>
            </div>

            <div
              class="h-12 bg-black/40 mt-1 rounded-b flex items-center justify-center gap-4 shrink-0"
            >
              <button
                onclick="toggleNetworkLayer()"
                class="gsap-btn p-2 hover:bg-white/10 rounded-full text-cyan-400 transition relative"
                title="Toggle Network Grid"
              >
                <i data-lucide="wifi" class="w-5 h-5"></i>
                <div
                  id="network-indicator"
                  class="hidden absolute top-0 right-0 w-2 h-2 bg-green-500 rounded-full"
                ></div>
              </button>
              <button
                onclick="panToCenter()"
                class="gsap-btn p-2 hover:bg-white/10 rounded-full text-cyan-400 transition"
                title="Re-Center Drone"
              >
                <i data-lucide="crosshair" class="w-5 h-5"></i>
              </button>
              <button
                onclick="spawnWave()"
                class="gsap-btn p-2 hover:bg-white/10 rounded-full text-cyan-400 transition"
                title="Simulate Crowd Surge"
              >
                <i data-lucide="users" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- RIGHT STATS PANEL -->
        <div
          class="col-span-1 lg:col-span-3 flex flex-col gap-4 order-3 min-h-[300px]"
        >
          <div
            class="glass-panel flex-1 rounded-lg p-4 md:p-6 flex flex-col dashboard-item"
          >
            <h3 class="text-lg md:text-xl tech-text text-cyan-400 mb-6 pb-2">
              TARGET ANALYSIS
            </h3>

            <div class="flex-1 flex flex-col gap-6 justify-center">
              <div
                class="bg-gradient-to-r from-blue-900/40 to-transparent p-4 rounded-l-lg border-l-4 border-blue-500 transition-all hover:bg-blue-900/60"
              >
                <p
                  class="text-[10px] text-gray-400 uppercase tracking-widest mb-1"
                >
                  TRACKED ENTITIES
                </p>
                <div class="flex items-end gap-2">
                  <span
                    id="total-count"
                    class="text-5xl md:text-6xl font-bold stat-value text-white"
                    >0</span
                  >
                  <span class="text-xs text-blue-400 mb-2 font-mono"
                    >Active</span
                  >
                </div>
              </div>

              <div class="space-y-4">
                <p
                  class="text-[10px] text-gray-500 uppercase tracking-widest pb-1"
                >
                  BIOMETRICS
                </p>

                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span class="text-green-400"
                      ><i data-lucide="network" class="inline w-3 h-3"></i>
                      Network Load</span
                    >
                    <span
                      id="network-load-val"
                      class="font-mono text-xs text-green-200"
                      >NORMAL</span
                    >
                  </div>
                  <div
                    class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden"
                  >
                    <div
                      id="network-load-bar"
                      class="bg-green-500 h-full w-0 transition-all duration-300"
                    ></div>
                  </div>
                </div>

                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span class="text-yellow-400"
                      ><i data-lucide="activity" class="inline w-3 h-3"></i>
                      Crowd Sentiment</span
                    >
                    <span
                      id="dominant-emotion"
                      class="font-mono text-xs uppercase text-yellow-200"
                      >NEUTRAL</span
                    >
                  </div>
                </div>

                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span class="text-cyan-400"
                      ><i data-lucide="map-pin" class="inline w-3 h-3"></i>
                      Sector Density</span
                    >
                    <span id="current-density" class="font-mono text-xs"
                      >Low</span
                    >
                  </div>
                  <div
                    class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden"
                  >
                    <div
                      id="density-bar-live"
                      class="bg-cyan-500 h-full w-0 transition-all duration-300"
                    ></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="hidden"><span id="latest-uid"></span></div>

            <div
              class="mt-6 h-32 overflow-hidden relative border-t border-white/5 pt-2"
            >
              <div
                class="absolute inset-0 bg-gradient-to-t from-gray-900/90 to-transparent pointer-events-none"
              ></div>
              <div
                id="detection-log"
                class="text-[10px] font-mono space-y-1 text-gray-400 h-full overflow-y-auto pr-2"
              >
                <p>[System] Drone link standby...</p>
              </div>
            </div>
          </div>

          <button
            onclick="toggleLockdown()"
            class="gsap-btn glass-panel h-20 rounded-lg p-4 flex items-center justify-between group hover:bg-red-900/20 transition-colors cursor-pointer border-red-500/20 hover:border-red-500/50 w-full text-left dashboard-item"
          >
            <div>
              <h4 class="text-red-400 font-bold text-sm tracking-wider">
                CONTAINMENT
              </h4>
              <p class="text-[10px] text-red-300/60">Lockdown Sector</p>
            </div>
            <div
              class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center group-hover:bg-red-500 group-hover:text-black transition-all"
            >
              <i data-lucide="siren" class="w-4 h-4"></i>
            </div>
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize Lucide Icons
      lucide.createIcons();

      // ============================================
      //  THREE.JS BACKGROUND - CYBER CORE
      // ============================================
      let scene, camera, renderer;
      let particlesMesh, globe, core, gridHelper;
      let mouseX = 0,
        mouseY = 0;

      const initThreeJS = () => {
        const container = document.getElementById("canvas-container");
        scene = new THREE.Scene();
        // Fog to blend items into the dark background
        scene.fog = new THREE.FogExp2(0x050510, 0.05);

        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // 1. Particle Starfield
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 1500;
        const posArray = new Float32Array(particlesCount * 3);

        for (let i = 0; i < particlesCount * 3; i++) {
          posArray[i] = (Math.random() - 0.5) * 30; // Wider spread
        }

        particlesGeometry.setAttribute(
          "position",
          new THREE.BufferAttribute(posArray, 3)
        );
        const particlesMaterial = new THREE.PointsMaterial({
          size: 0.02,
          color: 0x00f0ff,
          transparent: true,
          opacity: 0.8,
        });
        particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);

        // 2. Wireframe Globe (The Core)
        const globeGeo = new THREE.IcosahedronGeometry(2.5, 1);
        const globeMat = new THREE.MeshBasicMaterial({
          color: 0x0044aa,
          wireframe: true,
          transparent: true,
          opacity: 0.15,
        });
        globe = new THREE.Mesh(globeGeo, globeMat);
        scene.add(globe);

        // 3. Inner Core
        const coreGeo = new THREE.IcosahedronGeometry(1.2, 0);
        const coreMat = new THREE.MeshBasicMaterial({
          color: 0x00f0ff,
          wireframe: true,
          transparent: true,
          opacity: 0.2,
        });
        core = new THREE.Mesh(coreGeo, coreMat);
        scene.add(core);

        // 4. Moving Grid Floor
        const gridSize = 40;
        const gridDivisions = 40;
        gridHelper = new THREE.GridHelper(
          gridSize,
          gridDivisions,
          0x00f0ff,
          0x001133
        );
        gridHelper.position.y = -3;
        scene.add(gridHelper);

        // Event Listener for Mouse Parallax
        document.addEventListener("mousemove", (event) => {
          mouseX = event.clientX / window.innerWidth - 0.5;
          mouseY = event.clientY / window.innerHeight - 0.5;
        });

        // Animation Loop
        const animate = () => {
          requestAnimationFrame(animate);

          // Rotations
          particlesMesh.rotation.y += 0.0005;
          globe.rotation.y += 0.001;
          globe.rotation.x += 0.0005;
          core.rotation.y -= 0.003;

          // Grid movement effect (infinite scroll illusion)
          gridHelper.position.z = (Date.now() * 0.001) % 1;

          // Parallax Camera
          camera.position.x += (mouseX * 1 - camera.position.x) * 0.05;
          camera.position.y += (-mouseY * 1 - camera.position.y) * 0.05;
          camera.lookAt(scene.position);

          renderer.render(scene, camera);
        };
        animate();

        window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Remove Loader
        setTimeout(() => {
          const loader = document.getElementById("scene-loader");
          loader.style.opacity = "0";
          setTimeout(() => loader.remove(), 1000);

          // Trigger landing page entry
          gsap.from("#landing-panel", {
            duration: 1.5,
            y: 50,
            opacity: 0,
            ease: "power3.out",
            delay: 0.5,
          });
          gsap.from("#landing-logo", {
            duration: 1,
            scale: 0,
            rotation: 180,
            ease: "back.out(1.7)",
            delay: 1,
          });
        }, 1500);
      };

      initThreeJS();

      // ============================================
      //  GSAP INTERACTIVITY & TRANSITIONS
      // ============================================

      // Button Hover Effects
      document.querySelectorAll(".gsap-btn").forEach((btn) => {
        btn.addEventListener("mouseenter", () => {
          gsap.to(btn, { scale: 1.02, duration: 0.3, ease: "power2.out" });
        });
        btn.addEventListener("mouseleave", () => {
          gsap.to(btn, { scale: 1, duration: 0.3, ease: "power2.out" });
        });
      });

      // Advanced View Transition Function
      function transitionToView(hideIds, showId) {
        const tl = gsap.timeline();

        // 1. Exit Animation (Glitch Out)
        hideIds.forEach((id) => {
          const el = document.getElementById(id);
          if (!el.classList.contains("hidden")) {
            tl.to(
              el,
              {
                duration: 0.4,
                opacity: 0,
                scale: 0.9,
                filter: "blur(10px)",
                ease: "power2.in",
                onComplete: () => el.classList.add("hidden"),
              },
              "<"
            ); // Run concurrently
          }
        });

        // 2. Prep New View
        const newView = document.getElementById(showId);

        tl.add(() => {
          newView.classList.remove("hidden");
          // If dashboard, stagger items
          if (showId === "dashboard-view") {
            newView.style.display = "flex";
          }
        });

        // 3. Entry Animation (Boot Up)
        tl.fromTo(
          newView,
          { opacity: 0, scale: 1.1, filter: "blur(20px)" },
          {
            opacity: 1,
            scale: 1,
            filter: "blur(0px)",
            duration: 0.8,
            ease: "power2.out",
          }
        );

        // Specific stagger for dashboard items if entering dashboard
        if (showId === "dashboard-view") {
          tl.fromTo(
            ".dashboard-item",
            { y: 20, opacity: 0 },
            {
              y: 0,
              opacity: 1,
              duration: 0.5,
              stagger: 0.1,
              ease: "power2.out",
            },
            "-=0.5"
          );
        }
      }

      // --- CLOCK ---
      setInterval(() => {
        const now = new Date();
        document.getElementById("clock").innerText = now.toLocaleTimeString(
          "en-US",
          { hour12: false }
        );
      }, 1000);

      // ============================================
      //        CROWDSENSE LOGIC INTEGRATION
      // ============================================

      const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwQRQSRCC2TSPImjmfe2o_ghK43W-astnJOKDPimVhUrd6oWwq2y-HwS2KglyWwjU8pPA/exec";

      let sessionId = localStorage.getItem("cs_session_id") || generateUUID();
      localStorage.setItem("cs_session_id", sessionId);
      let map,
        circles = [],
        markers = [],
        adminMarker;
      let networkLayerVisible = false;
      let userAlertPoller;

      // --- Auth Logic ---
      function showLogin() {
        const landing = document.getElementById("landing-page");
        const login = document.getElementById("login-view");

        // Hide landing content temporarily
        gsap.to("#landing-panel", { opacity: 0, scale: 0.95, duration: 0.3 });

        login.classList.remove("hidden");
        gsap.to("#login-panel", {
          opacity: 1,
          scale: 1,
          duration: 0.4,
          ease: "back.out(1.2)",
        });
      }

      function cancelLogin() {
        const login = document.getElementById("login-view");
        gsap.to("#login-panel", {
          opacity: 0,
          scale: 0.95,
          duration: 0.3,
          onComplete: () => {
            login.classList.add("hidden");
            // Reveal landing again
            gsap.to("#landing-panel", { opacity: 1, scale: 1, duration: 0.4 });
          },
        });

        // Clear inputs
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        document.getElementById("login-error").classList.add("hidden");
      }

      function checkLogin() {
        const user = document.getElementById("username").value;
        const pass = document.getElementById("password").value;
        const errorMsg = document.getElementById("login-error");

        if (user === "admin" && pass === "1223334444") {
          // Success: Transition to Dashboard
          document.getElementById("login-view").classList.add("hidden");
          startOwnerMode();
        } else {
          errorMsg.classList.remove("hidden");
          gsap.from(errorMsg, { x: 10, duration: 0.1, repeat: 3, yoyo: true }); // Shake effect
        }
      }

      // --- Navigation ---
      function startSensorMode() {
        transitionToView(["landing-page"], "sensor-view");
        document.getElementById("displaySessionId").innerText =
          sessionId.substring(0, 8);

        // Animate Sensor UI
        gsap.from("#sensor-circle", {
          scale: 0,
          duration: 1,
          ease: "elastic.out(1, 0.5)",
          delay: 0.5,
        });
        gsap.from("#sensor-stats", {
          opacity: 0,
          y: 20,
          duration: 0.8,
          delay: 0.8,
        });

        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(sendPing, handleError);
          setInterval(() => {
            navigator.geolocation.getCurrentPosition(sendPing, handleError);
          }, 15000);
        } else {
          alert("GPS hardware not detected.");
        }

        // --- START USER ALERT MONITORING ---
        // Checks local storage every 2 seconds to see if admin triggered lockdown
        if (userAlertPoller) clearInterval(userAlertPoller);
        userAlertPoller = setInterval(() => {
          const isLockdown = localStorage.getItem("sray_lockdown") === "true";
          const alertContainer = document.getElementById(
            "user-alert-container"
          );
          const sensorCircle = document.getElementById("sensor-circle");
          const sensorIcon = document.getElementById("sensor-icon");

          if (isLockdown && alertContainer.classList.contains("hidden")) {
            // Trigger Alert View
            alertContainer.classList.remove("hidden");
            gsap.from(alertContainer, { y: 20, opacity: 0, duration: 0.5 });

            // Change Circle to Danger Mode
            sensorCircle.classList.replace("border-cyan-500", "border-red-500");
            sensorCircle.classList.add("animate-pulse"); // Add heavy pulse

            // document.getElementById('sensor-ping').classList.replace('border-cyan-200', 'border-red-200'); // Element might not exist in loop if hidden? No it's there.
            sensorIcon.classList.replace("text-cyan-400", "text-red-500");
            document.getElementById("sensor-status-text").innerText = "DANGER";
            document
              .getElementById("sensor-status-text")
              .classList.add("text-red-500");
            document.getElementById("sensor-sub-text").innerText =
              "CROWD SURGE DETECTED";
          } else if (
            !isLockdown &&
            !alertContainer.classList.contains("hidden")
          ) {
            // Reset View
            alertContainer.classList.add("hidden");

            sensorCircle.classList.replace("border-red-500", "border-cyan-500");
            sensorCircle.classList.remove("animate-pulse");

            // document.getElementById('sensor-ping').classList.replace('border-red-200', 'border-cyan-200');
            sensorIcon.classList.replace("text-red-500", "text-cyan-400");
            document.getElementById("sensor-status-text").innerText = "ACTIVE";
            document
              .getElementById("sensor-status-text")
              .classList.remove("text-red-500");
            document.getElementById("sensor-sub-text").innerText =
              "SENDING PACKETS";
          }
        }, 2000);
      }

      function exitSensorMode() {
        if (userAlertPoller) clearInterval(userAlertPoller);
        transitionToView(["sensor-view"], "landing-page");
        gsap.from("#landing-panel", { y: 20, opacity: 0, delay: 0.5 });
      }

      function startOwnerMode() {
        transitionToView(["landing-page"], "dashboard-view");
        loadProfile(); // Load admin profile settings

        // Needed for Leaflet to size correctly after being hidden
        setTimeout(initMap, 200);

        // Initialize Admin features
        locateAdmin();
      }

      function exitAdminMode() {
        transitionToView(["dashboard-view"], "landing-page");
        gsap.from("#landing-panel", { y: 20, opacity: 0, delay: 0.5 });
      }

      function locateAdmin() {
        if ("geolocation" in navigator && map) {
          navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            if (adminMarker) map.removeLayer(adminMarker);

            adminMarker = L.circleMarker([lat, lng], {
              color: "#0044ff",
              fillColor: "#0088ff",
              fillOpacity: 1,
              radius: 8,
              weight: 3,
            }).addTo(map);

            adminMarker.bindPopup("<b>ADMINISTRATOR</b><br>LIVE LOCATION");

            if (!map.getCenter().lat) map.setView([lat, lng], 16);
          });
        }
      }

      function openSetupModal() {
        const modal = document.getElementById("setupModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        gsap.fromTo(
          modal.firstElementChild,
          { scale: 0.9, opacity: 0 },
          { scale: 1, opacity: 1, duration: 0.3 }
        );

        if ("geolocation" in navigator) {
          document.getElementById("zoneLat").value = "";
          document.getElementById("zoneLng").value = "";
          navigator.geolocation.getCurrentPosition((pos) => {
            document.getElementById("zoneLat").value =
              pos.coords.latitude.toFixed(6);
            document.getElementById("zoneLng").value =
              pos.coords.longitude.toFixed(6);
          });
        }
      }

      function closeSetupModal() {
        const modal = document.getElementById("setupModal");
        gsap.to(modal.firstElementChild, {
          scale: 0.9,
          opacity: 0,
          duration: 0.2,
          onComplete: () => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          },
        });
      }

      function submitSetup() {
        const name = document.getElementById("zoneName").value;
        const lat = document.getElementById("zoneLat").value;
        const lng = document.getElementById("zoneLng").value;
        const radius = document.getElementById("zoneRadius").value;
        const limit = document.getElementById("zoneLimit").value;

        if (!name || !lat || !lng) return alert("MISSING SECTOR DATA");

        const data = {
          action: "register_area",
          name: name,
          lat: lat,
          lng: lng,
          radius: radius,
          limit: limit,
        };

        fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(data),
        })
          .then((r) => r.json())
          .then((d) => {
            alert("SECTOR CONFIGURED: " + d.message);
            closeSetupModal();
          });
      }

      // --- ADMIN PROFILE EDIT LOGIC ---
      function openProfileEdit() {
        const modal = document.getElementById("profileEditModal");
        const currentName = document.getElementById("admin-name").innerText;
        const currentAvatar = document.getElementById("admin-avatar").src;

        document.getElementById("edit-admin-name").value = currentName;
        document.getElementById("edit-admin-avatar").value = currentAvatar;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        gsap.fromTo(
          modal.firstElementChild,
          { scale: 0.9, opacity: 0 },
          { scale: 1, opacity: 1, duration: 0.3 }
        );
      }

      function closeProfileEdit() {
        const modal = document.getElementById("profileEditModal");
        gsap.to(modal.firstElementChild, {
          scale: 0.9,
          opacity: 0,
          duration: 0.2,
          onComplete: () => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          },
        });
      }

      function saveProfile() {
        const newName = document.getElementById("edit-admin-name").value;
        const newAvatar = document.getElementById("edit-admin-avatar").value;

        if (newName) {
          localStorage.setItem("sray_admin_name", newName);
          document.getElementById("admin-name").innerText = newName;
        }
        if (newAvatar) {
          localStorage.setItem("sray_admin_avatar", newAvatar);
          document.getElementById("admin-avatar").src = newAvatar;
        }
        closeProfileEdit();
      }

      function loadProfile() {
        const savedName = localStorage.getItem("sray_admin_name");
        const savedAvatar = localStorage.getItem("sray_admin_avatar");

        if (savedName)
          document.getElementById("admin-name").innerText = savedName;
        if (savedAvatar)
          document.getElementById("admin-avatar").src = savedAvatar;
      }

      // --- Sensor Logic ---
      function sendPing(position) {
        const data = {
          action: "ping",
          sessionId: sessionId,
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };
        // Fix for element update if sensor view is hidden
        const pingTime = document.getElementById("lastPingTime");
        if (pingTime) pingTime.innerText = new Date().toLocaleTimeString();

        fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(data),
        }).catch((e) => console.log("Ping dispatch", e));
      }

      function handleError(err) {
        console.error(err);
      }

      // --- Dashboard Logic ---
      function initSystem() {
        const placeholder = document.getElementById("camera-placeholder");
        const loadingText = document.getElementById("loading-text");
        const btn = document.getElementById("init-btn");

        btn.style.display = "none";
        loadingText.classList.remove("hidden");

        // Fake initialization delay with GSAP
        setTimeout(() => {
          gsap.to(placeholder, {
            opacity: 0,
            duration: 0.5,
            onComplete: () => {
              placeholder.style.display = "none";
            },
          });

          document.getElementById("model-status").innerText = "ACTIVE";
          document.getElementById("model-status").className =
            "text-green-400 animate-pulse";
          initMap();
          fetchDashboardData();
          setInterval(fetchDashboardData, 10000);
          if (Notification.permission !== "granted")
            Notification.requestPermission();
        }, 2000);
      }

      function initMap() {
        if (map) {
          map.invalidateSize();
          return;
        }
        // Default View
        map = L.map("map", {
          zoomControl: false,
          attributionControl: false,
        }).setView([19.3858, 72.8285], 16);

        // Dark Matter Map Theme
        L.tileLayer(
          "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
          {
            maxZoom: 19,
          }
        ).addTo(map);

        // Mouse move for HUD
        map.on("mousemove", function (e) {
          document.getElementById("lat-display").innerText =
            e.latlng.lat.toFixed(4);
          document.getElementById("lng-display").innerText =
            e.latlng.lng.toFixed(4);
        });

        window.addEventListener("resize", () => {
          map.invalidateSize();
        });
      }

      async function fetchDashboardData() {
        try {
          const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
          const data = await res.json();
          updateUI(data);
        } catch (e) {
          console.error("Data Uplink Failed", e);
          document.getElementById("connectionStatus").innerText = "OFFLINE";
          document
            .getElementById("connectionStatus")
            .classList.replace("text-green-400", "text-red-500");
        }
      }

      function updateUI(data) {
        const total = data.totalActiveSensors || 0;

        // GSAP counter animation
        const counter = document.getElementById("total-count");
        gsap.to(counter, {
          innerText: total,
          duration: 1,
          snap: { innerText: 1 },
          ease: "power1.inOut",
        });

        const loadPct = Math.min(total * 2, 100);
        document.getElementById("network-load-bar").style.width = loadPct + "%";
        document.getElementById("network-load-val").innerText =
          loadPct > 80 ? "HIGH" : "NORMAL";

        // Clear old layers
        circles.forEach((c) => map.removeLayer(c));
        circles = [];
        markers.forEach((m) => map.removeLayer(m));
        markers = [];

        const log = document.getElementById("detection-log");
        let globalDensity = 0;

        if (data.areas && data.areas.length > 0) {
          data.areas.forEach((area) => {
            let density = area.currentCount / area.limit;
            if (density > globalDensity) globalDensity = density;

            let areaColor = "#00f0ff";
            if (area.status === "moderate") areaColor = "#eab308";
            if (area.status === "crowded") {
              areaColor = "#ff0000";
              logAlert(area);
            }

            const circle = L.circle([area.lat, area.lng], {
              color: areaColor,
              fillColor: areaColor,
              fillOpacity: 0.05,
              radius: area.radius,
              weight: 1,
              dashArray: "5, 5",
            }).addTo(map);

            circle.bindPopup(`
                  <div class="p-1">
                      <strong class="font-orbitron block border-b border-cyan-500/50 mb-1">${
                        area.name
                      }</strong>
                      <div class="text-xs font-mono">
                         COUNT: ${area.currentCount}/${area.limit}<br>
                         STATUS: ${area.status.toUpperCase()}
                      </div>
                  </div>
              `);
            circles.push(circle);

            for (let i = 0; i < area.currentCount; i++) {
              const r = area.radius * Math.sqrt(Math.random());
              const theta = Math.random() * 2 * Math.PI;

              const earthRadius = 6378137;
              const dLat =
                ((r * Math.cos(theta)) / earthRadius) * (180 / Math.PI);
              const dLng =
                ((r * Math.sin(theta)) /
                  (earthRadius * Math.cos((Math.PI * area.lat) / 180))) *
                (180 / Math.PI);

              const dotLat = area.lat + dLat;
              const dotLng = area.lng + dLng;

              const dot = L.circleMarker([dotLat, dotLng], {
                color: "transparent",
                fillColor: "#80eaff",
                fillOpacity: 0.8,
                radius: 2,
              }).addTo(map);
              markers.push(dot);
            }
          });
        }

        const bar = document.getElementById("density-bar-live");
        const densityText = document.getElementById("current-density");

        let pct = Math.min(globalDensity * 100, 100);
        bar.style.width = pct + "%";

        if (pct > 80) {
          bar.className =
            "h-full transition-all duration-500 bg-red-500 shadow-[0_0_10px_red]";
          densityText.innerText = "CRITICAL";
          densityText.className =
            "font-mono text-xs text-red-500 animate-pulse";
        } else if (pct > 50) {
          bar.className = "h-full transition-all duration-500 bg-yellow-500";
          densityText.innerText = "MODERATE";
          densityText.className = "font-mono text-xs text-yellow-500";
        } else {
          bar.className = "h-full transition-all duration-500 bg-cyan-500";
          densityText.innerText = "LOW";
          densityText.className = "font-mono text-xs text-cyan-500";
        }
      }

      function logAlert(area) {
        const log = document.getElementById("detection-log");
        const p = document.createElement("p");
        p.className = "text-red-400 border-l-2 border-red-500 pl-2 mb-1";
        p.innerText = `[ALERT] ${new Date().toLocaleTimeString()} - ${
          area.name
        } OVERLOAD`;
        log.prepend(p);

        if (Notification.permission === "granted") {
          new Notification(`🚨 S-RAY ALERT: ${area.name}`, {
            body: "Sector Capacity Exceeded",
          });
        }

        // Trigger red UI (ADMIN ONLY)
        const alertBox = document.getElementById("critical-alert-box");
        const alertText = document.getElementById("critical-alert-text");

        // Use custom admin text
        alertText.innerText =
          "ALERT: Property is getting crowded. Send security immediately to handle them.";

        alertBox.classList.remove("hidden");
        gsap.to(alertBox, { y: 0, duration: 0.5, ease: "back.out" });

        document.body.classList.add("critical-mode");

        // Keep it visible longer or until dismissed
      }

      function dismissAlert() {
        const alertBox = document.getElementById("critical-alert-box");
        gsap.to(alertBox, {
          y: -100,
          duration: 0.5,
          onComplete: () => {
            alertBox.classList.add("hidden");
            document.body.classList.remove("critical-mode");
          },
        });
      }

      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            var r = (Math.random() * 16) | 0,
              v = c == "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      // --- Helper Functions ---

      function toggleNetworkLayer() {
        networkLayerVisible = !networkLayerVisible;
        const status = document.getElementById("network-status");
        const indicator = document.getElementById("network-indicator");

        if (networkLayerVisible) {
          status.innerText = "VISUALIZING";
          status.classList.replace("text-purple-400", "text-cyan-400");
          indicator.classList.remove("hidden");
          gsap.from(indicator, { scale: 0, duration: 0.3 });
          alert("Network Grid Overlay Enabled");
        } else {
          status.innerText = "INACTIVE";
          status.classList.replace("text-cyan-400", "text-purple-400");
          indicator.classList.add("hidden");
        }
      }

      function panToCenter() {
        if (map) {
          if (circles.length > 0) {
            map.setView(circles[0].getLatLng(), 16);
          } else {
            map.setView([19.3858, 72.8285], 16);
          }
        }
      }

      function spawnWave() {
        simulateCrowd();
      }

      function simulateCrowd() {
        if (!map) return;
        const center = map.getCenter();
        for (let i = 0; i < 10; i++) {
          const latOff = (Math.random() - 0.5) * 0.001;
          const lngOff = (Math.random() - 0.5) * 0.001;
          const fakeData = {
            action: "ping",
            sessionId: "BOT-" + generateUUID(),
            lat: center.lat + latOff,
            lng: center.lng + lngOff,
          };
          fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(fakeData),
          });
        }

        const log = document.getElementById("detection-log");
        const p = document.createElement("p");
        p.className = "text-purple-400 border-l-2 border-purple-500 pl-2 mb-1";
        p.innerText = `[SIM] ${new Date().toLocaleTimeString()} - INJECTING 10 NODES`;
        log.prepend(p);
      }

      function toggleLockdown() {
        const currentState = localStorage.getItem("sray_lockdown") === "true";
        const newState = !currentState;
        localStorage.setItem("sray_lockdown", newState);

        if (newState) {
          document.body.classList.add("critical-mode");
          gsap.to("body", {
            backgroundColor: "#300000",
            duration: 0.1,
            yoyo: true,
            repeat: 3,
            onComplete: () => gsap.set("body", { backgroundColor: "#050510" }),
          });
          // Alert logic is handled in the UI update, but we can trigger immediate visual feedback
        } else {
          document.body.classList.remove("critical-mode");
          alert("LOCKDOWN LIFTED");
        }
      }

      function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const colors = {
          bg: [5, 5, 16],
          cyan: [0, 240, 255],
          red: [255, 0, 0],
          white: [255, 255, 255],
          panel: [16, 20, 30],
          grid: [30, 40, 60],
          textMuted: [150, 150, 150],
        };

        doc.setFillColor(...colors.bg);
        doc.rect(0, 0, 210, 297, "F");

        doc.setFont("courier", "bold");
        doc.setFontSize(24);
        doc.setTextColor(...colors.cyan);
        doc.text("S-RAY SURVEILLANCE", 15, 20);

        doc.setFontSize(10);
        doc.setTextColor(...colors.white);
        doc.text("GEO-SPATIAL INTELLIGENCE REPORT", 15, 26);

        doc.setDrawColor(...colors.red);
        doc.setLineWidth(0.5);
        doc.rect(150, 10, 45, 12);
        doc.setTextColor(...colors.red);
        doc.setFontSize(8);
        doc.text("CLASSIFIED // LEVEL 5", 152, 18);

        doc.setDrawColor(...colors.cyan);
        doc.setLineWidth(0.5);
        doc.line(15, 35, 195, 35);

        doc.setFont("courier", "normal");
        doc.setFontSize(9);
        doc.setTextColor(...colors.textMuted);

        const dateStr = new Date().toLocaleString().toUpperCase();
        doc.text(`TIMESTAMP : ${dateStr}`, 15, 45);
        doc.text(`AGENT ID  : COMMANDER (ADMIN)`, 15, 50);
        doc.text(`SECTOR    : 09 - NEW DELHI`, 15, 55);

        doc.setFillColor(...colors.panel);
        doc.setDrawColor(...colors.cyan);
        doc.rect(15, 65, 85, 30, "FD");
        doc.rect(110, 65, 85, 30, "FD");

        const total = document.getElementById("total-count").innerText || "0";
        const density =
          document.getElementById("current-density").innerText || "UNKNOWN";

        doc.setFontSize(20);
        doc.setTextColor(...colors.white);
        doc.text(total, 20, 80);
        doc.setFontSize(8);
        doc.setTextColor(...colors.cyan);
        doc.text("ACTIVE ENTITIES", 20, 88);

        doc.setFontSize(14);
        if (density.includes("CRIT") || density.includes("High")) {
          doc.setTextColor(...colors.red);
        } else {
          doc.setTextColor(...colors.cyan);
        }
        doc.text(density.toUpperCase(), 115, 80);
        doc.setFontSize(8);
        doc.setTextColor(...colors.cyan);
        doc.text("SECTOR DENSITY", 115, 88);

        doc.setFontSize(10);
        doc.setTextColor(...colors.white);
        doc.text("REAL-TIME SECTOR MAP SNAPSHOT", 15, 110);

        const mapX = 15;
        const mapY = 115;
        const mapW = 180;
        const mapH = 90;

        doc.setFillColor(10, 15, 25);
        doc.setDrawColor(...colors.cyan);
        doc.setLineWidth(0.2);
        doc.rect(mapX, mapY, mapW, mapH, "FD");

        doc.setDrawColor(...colors.grid);
        for (let i = 1; i < 10; i++) {
          doc.line(
            mapX + i * (mapW / 10),
            mapY,
            mapX + i * (mapW / 10),
            mapY + mapH
          );
          doc.line(
            mapX,
            mapY + i * (mapH / 10),
            mapX + mapW,
            mapY + i * (mapH / 10)
          );
        }

        doc.setDrawColor(...colors.cyan);
        doc.setLineWidth(0.5);
        const cx = mapX + mapW / 2;
        const cy = mapY + mapH / 2;
        doc.line(cx - 30, cy - 30, cx + 30, cy - 30);
        doc.line(cx + 30, cy - 30, cx + 50, cy);
        doc.line(cx + 50, cy, cx + 30, cy + 30);
        doc.line(cx + 30, cy + 30, cx - 30, cy + 30);
        doc.line(cx - 30, cy + 30, cx - 50, cy);
        doc.line(cx - 50, cy, cx - 30, cy - 30);

        const entityCount = parseInt(total) || 5;
        doc.setFillColor(...colors.red);
        for (let k = 0; k < Math.min(entityCount, 20); k++) {
          const rx = cx + (Math.random() * 80 - 40);
          const ry = cy + (Math.random() * 60 - 30);
          doc.circle(rx, ry, 1, "F");
        }

        doc.setFontSize(6);
        doc.setTextColor(...colors.cyan);
        doc.text("SAT-LINK: ACTIVE", mapX + 5, mapY + 8);
        doc.text("ZOOM: 400%", mapX + 5, mapY + mapH - 5);
        doc.text("[ LIVE FEED ]", mapX + mapW - 25, mapY + 8);

        doc.setFontSize(10);
        doc.setTextColor(...colors.white);
        doc.text("MISSION CONTEXT & INTELLIGENCE", 15, 220);
        doc.setDrawColor(50, 50, 50);
        doc.line(15, 223, 80, 223);

        doc.setFont("courier", "normal");
        doc.setFontSize(8);
        doc.setTextColor(200, 200, 200);

        const contextText = [
          "OPERATIONAL BRIEF: Surveillance grid alpha-9 detects anomalous movement patterns consistent with unauthorized entry.",
          "PRIMARY OBJECTIVE: Maintain geo-fence integrity. All units are authorized to engage trackers on high-density signals.",
          "THREAT ASSESSMENT: Level 4. Several signatures indicate encrypted comms devices. S-RAY algorithms are currently decrypting signal packets.",
          "NEXT STEPS: Continue monitoring Sector 09. Deploy drone swarms if density exceeds critical mass (95%). Report anomalies to Central Command immediately.",
        ];

        let contextY = 230;
        contextText.forEach((line) => {
          const splitText = doc.splitTextToSize(`>> ${line}`, 180);
          doc.text(splitText, 15, contextY);
          contextY += splitText.length * 4 + 2;
        });

        doc.setFontSize(7);
        doc.setTextColor(80, 80, 80);
        doc.text("S-RAY SYSTEM GENERATED REPORT // DO NOT DISTRIBUTE", 15, 280);
        doc.text(`DOC_ID: ${Math.floor(Math.random() * 1000000)}`, 160, 280);

        doc.save("S-RAY_Mission_Report.pdf");
      }
    </script>
  </body>
</html>
